version: '3.8'

services:
  shopping-list-nginx:
    image: nginx:alpine
    container_name: shopping-list-app
    restart: unless-stopped
    ports:
      - "8443:443"
      - "8080:80"
    volumes:
      - ./nginx-full.conf:/etc/nginx/conf.d/default.conf:ro
      - shopping-data:/usr/share/nginx/html:ro
      - shopping-ssl:/etc/nginx/ssl:ro
    networks:
      - web
    depends_on:
      - shopping-setup

  shopping-setup:
    image: alpine:latest
    container_name: shopping-setup
    volumes:
      - shopping-data:/data
      - shopping-ssl:/ssl
    command: >
      sh -c "
        apk add --no-cache openssl &&
        if [ ! -f /ssl/cert.pem ]; then
          echo 'Generating SSL certificate...' &&
          openssl req -x509 -nodes -days 365 -newkey rsa:2048 
            -keyout /ssl/key.pem 
            -out /ssl/cert.pem 
            -subj '/C=IL/ST=Israel/L=Local/O=Shopping/CN=192.168.1.180' &&
          echo 'SSL generated!';
        fi &&
        echo 'Setup complete!'
      "

volumes:
  shopping-data:
    driver: local
  shopping-ssl:
    driver: local

networks:
  web:
    driver: bridge
